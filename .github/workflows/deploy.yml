name: Smart Deploy with tmux & Healthcheck

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Deploy via SSH (tmux-managed)
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.SERVER_IP }}
          username: root
          key: ${{ secrets.SSH_KEY }}
          timeout: 60m
          script: |
            # –≤—Ä–µ–º—è –Ω–∞—á–∞–ª–∞ –¥–µ–ø–ª–æ—è
            START_TIME=$(date +%s)
            COMMIT="${{ github.sha }}"
            COMMIT_SHORT=${COMMIT:0:7}

            echo "üöÄ Starting tmux deploy on $(hostname)"

            if tmux has-session -t deploy 2>/dev/null; then
              echo "‚öôÔ∏è Killing previous deploy session..."
              tmux kill-session -t deploy
            fi

            tmux new-session -d -s deploy '
              set -e
              cd /root/telegram-vapor-bot
              echo "üßæ Updating repo..."
              git fetch origin main
              git reset --hard origin/main

              echo "üìÑ Rebuilding .env..."
              cat <<'"'"'EOF'"'"' > .env
              BOT_TOKEN=${{ secrets.BOT_TOKEN }}
              ADMIN_ID=${{ secrets.ADMIN_ID }}
              SERVER_IP=${{ secrets.SERVER_IP }}
              NGROK_URL=${{ secrets.NGROK_URL }}
              REDIS_URL=redis://bot:${{ secrets.REDIS_PASSWORD }}@redis:6379
              EOF

              echo "üîê Writing Redis ACL..."
              cat > redis-users.acl <<'"'"'ACL'"'"'
              user default off
              user bot on >${{ secrets.REDIS_PASSWORD }} ~* +@read +@write +@stream -FLUSHALL -FLUSHDB -CONFIG -SHUTDOWN
              ACL

              echo "üê≥ Rebuilding containers..."
              docker compose down
              docker compose up -d --build

              echo "üíì Waiting for Redis..."
              for i in {1..10}; do
                if docker exec redis redis-cli -u "redis://bot:${{ secrets.REDIS_PASSWORD }}@localhost:6379" ping | grep -q PONG; then
                  echo "‚úÖ Redis ready"
                  break
                fi
                echo "‚è≥ Waiting for Redis ($i/10)..."
                sleep 3
              done

              echo "üí° Checking bot health..."
              if curl -s http://localhost:3001 > /dev/null; then
                STATUS="‚úÖ Bot OK, webhook active"
              else
                STATUS="‚ö†Ô∏è Bot did not respond"
              fi
            '

            echo "‚úÖ tmux session launched. Waiting for completion..."
            while tmux has-session -t deploy 2>/dev/null; do
              echo "‚è≥ Deploy still running..."
              sleep 20
            done

            # ‚Üê –ó–î–ï–°–¨ —Å—á–∏—Ç–∞–µ–º –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å
            END=$(date +%s)
            DURATION=$((END - START))
            MINS=$(( DURATION / 60 ))
            SECS=$(( DURATION % 60 ))

            # —Å–æ–±–∏—Ä–∞–µ–º —Å—Ç–∞—Ç—É—Å—ã –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤
            DOCKER_STATUS=$(docker compose ps --format '{{.Name}} {{.State}}' \
              | sed 's/running/‚úÖ running/; s/exited/‚ùå exited/; s/restarting/üîÅ restarting/; s/created/üçº created/; s/paused/‚è∏Ô∏è paused/; s/unknown/‚öôÔ∏è unknown/')

            # —Ñ–æ—Ä–º–∏—Ä—É–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ
            MSG=$(cat <<EOF
            ‚úÖ *Deployment complete!*

            üß† *Project:* telegram-vapor-bot
            üïí *Time:* $(date)
            üíª *Host:* $(hostname)
            üîó *Commit:* $GITHUB_SHA
            ‚è±Ô∏è *Duration:* ${MINS}m ${SECS}s

            üì¶ *Containers:*
            \`\`\`
            $DOCKER_STATUS
            \`\`\`
            $STATUS
            EOF
            )

            # –æ—Ç–ø—Ä–∞–≤–∫–∞ –≤ Telegram –∫–∞–∫ –±—ã–ª–æ
            curl -s -X POST "https://api.telegram.org/bot${{ secrets.DEPLOY_NOTIFY_TOKEN }}/sendMessage" \
              -d "chat_id=${{ secrets.DEPLOY_NOTIFY_CHAT }}" \
              -d "parse_mode=Markdown" \
              --data-urlencode "text=$MSG" > /dev/null
