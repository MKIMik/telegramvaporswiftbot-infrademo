name: Smart Deploy with tmux & Healthcheck

on:
  push:
    branches:
      - main
  workflow_dispatch:
    inputs:
      demo:
        description: "Run in demo mode (no SSH connection)"
        required: false
        default: "true"

env:
  DEMO_MODE: ${{ github.event.inputs.demo || 'false' }}

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ§¾ Checkout repo
        uses: actions/checkout@v4

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # ğŸ§± DEMO MODE (ÑĞ¸Ğ¼ÑƒĞ»Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ½Ñ‹Ğ¹ Ğ´ĞµĞ¿Ğ»Ğ¾Ğ¹)
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: ğŸš€ Simulated Deploy (Demo Mode)
        if: env.DEMO_MODE == 'true'
        run: |
          echo "ğŸ§± DEMO MODE ENABLED"
          echo "This run will simulate the deploy process without SSH."
          echo ""
          echo "1ï¸âƒ£ Checking out repository..."
          sleep 1
          echo "2ï¸âƒ£ Building containers (simulated)..."
          sleep 1
          echo "3ï¸âƒ£ Redis healthcheck: âœ… PONG"
          echo "4ï¸âƒ£ Bot healthcheck: âœ… OK (simulated)"
          echo "5ï¸âƒ£ Containers: telegram_bot âœ…, redis âœ…"
          echo ""
          echo "ğŸ“¨ Sending simulated Telegram message..."
          echo "âœ… Deployment complete (demo mode)"
          echo ""
          echo "ğŸ‰ CI/CD Simulation finished successfully!"

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # ğŸ§© REAL MODE (Ñ€ĞµĞ°Ğ»ÑŒĞ½Ñ‹Ğ¹ Ğ´ĞµĞ¿Ğ»Ğ¾Ğ¹ Ñ SSH)
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: ğŸ§© Deploy via SSH (tmux-managed)
        if: env.DEMO_MODE == 'false'
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.SERVER_IP }}
          username: root
          key: ${{ secrets.SSH_KEY }}
          timeout: 60m
          script: |
            START_TIME=$(date +%s)
            COMMIT="${{ github.sha }}"
            COMMIT_SHORT=${COMMIT:0:7}

            echo "ğŸš€ Starting tmux deploy on $(hostname)"

            if tmux has-session -t deploy 2>/dev/null; then
              echo "âš™ï¸ Killing previous deploy session..."
              tmux kill-session -t deploy
            fi

            tmux new-session -d -s deploy '
              set -e
              cd /root/telegram-vapor-bot
              echo "ğŸ§¾ Updating repo..."
              git fetch origin main
              git reset --hard origin/main

              echo "ğŸ“„ Rebuilding .env..."
              cat <<'"'"'EOF'"'"' > .env
              BOT_TOKEN=${{ secrets.BOT_TOKEN }}
              ADMIN_ID=${{ secrets.ADMIN_ID }}
              SERVER_IP=${{ secrets.SERVER_IP }}
              NGROK_URL=${{ secrets.NGROK_URL }}
              REDIS_URL=redis://bot:${{ secrets.REDIS_PASSWORD }}@redis:6379
              EOF

              echo "ğŸ” Writing Redis ACL..."
              cat > redis-users.acl <<'"'"'ACL'"'"'
              user default off
              user bot on >${{ secrets.REDIS_PASSWORD }} ~* +@read +@write +@stream -FLUSHALL -FLUSHDB -CONFIG -SHUTDOWN
              ACL

              echo "ğŸ³ Rebuilding containers..."
              docker compose down
              docker compose up -d --build

              echo "ğŸ’“ Waiting for Redis..."
              for i in {1..10}; do
                if docker exec redis redis-cli -u "redis://bot:${{ secrets.REDIS_PASSWORD }}@localhost:6379" ping | grep -q PONG; then
                  echo "âœ… Redis ready"
                  break
                fi
                echo "â³ Waiting for Redis ($i/10)..."
                sleep 3
              done

              echo "ğŸ’¡ Checking bot health..."
              if curl -s http://localhost:3001 > /dev/null; then
                STATUS="âœ… Bot OK, webhook active"
              else
                STATUS="âš ï¸ Bot did not respond"
              fi
            '

            echo "âœ… tmux session launched. Waiting for completion..."
            while tmux has-session -t deploy 2>/dev/null; do
              echo "â³ Deploy still running..."
              sleep 20
            done

            END=$(date +%s)
            DURATION=$((END - START_TIME))
            MINS=$(( DURATION / 60 ))
            SECS=$(( DURATION % 60 ))

            DOCKER_STATUS=$(docker compose ps --format '{{.Name}} {{.State}}' \
              | sed 's/running/âœ… running/; s/exited/âŒ exited/; s/restarting/ğŸ” restarting/; s/created/ğŸ¼ created/; s/paused/â¸ï¸ paused/; s/unknown/âš™ï¸ unknown/')

            MSG=$(cat <<EOF
            âœ… *Deployment complete!*

            ğŸ§  *Project:* telegram-vapor-bot
            ğŸ•’ *Time:* $(date)
            ğŸ’» *Host:* $(hostname)
            ğŸ”— *Commit:* $GITHUB_SHA
            â±ï¸ *Duration:* ${MINS}m ${SECS}s

            ğŸ“¦ *Containers:*
            \`\`\`
            $DOCKER_STATUS
            \`\`\`
            $STATUS
            EOF
            )

            curl -s -X POST "https://api.telegram.org/bot${{ secrets.DEPLOY_NOTIFY_TOKEN }}/sendMessage" \
              -d "chat_id=${{ secrets.DEPLOY_NOTIFY_CHAT }}" \
              -d "parse_mode=Markdown" \
              --data-urlencode "text=$MSG" > /dev/null
